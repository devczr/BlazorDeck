@page "/"
@using BlazorDeck.Client.Authentication;
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components
@inject HttpClient httpClient
@inject IJSRuntime js
@inject ICardService CardService
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navManager
@inject Microsoft.Extensions.Configuration.IConfiguration config;

<PageTitle>Home</PageTitle>

<MudDropContainer T="CardGameItem" Items="_items" ItemsSelector="@((item,column) => item.Status == column)" ItemDropped="ItemUpdated" Class="d-flex flex-row mt-0 pt-0">
    <ChildContent>
        <MudGrid>

            <MudItem xs="12" Class="d-flex justify-center">
                @foreach (var item in _cardSlots.Where( c => c.SlotType == SlotType.World))
                {
                    <MudPaper Elevation="0" Width="160px" MinHeight="260px" Class="pa-4 ma-4 d-flex flex-column mud-background-gray rounded-lg" Style="color:#D8E2DC">
                        <MudToolBar DisableGutters="true">
                            <MudText Typo="Typo.subtitle1"><b>@item.Guid.ToString()</b></MudText>
                            <MudSpacer />
                            <MudMenu Icon="@Icons.Material.Rounded.MoreHoriz" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" ListClass="pa-2 d-flex flex-column" PopoverClass="mud-elevation-25">
                                <MudButton Size="Size.Small" Color="Color.Error" StartIcon="@Icons.Material.Outlined.Delete" OnClick="@( () => DeleteCardSlot(item))">Delete Section</MudButton>
                                <MudButton Size="Size.Small" Color="Color.Default" StartIcon="@Icons.Material.Rounded.Add" OnClick="@( () => AddCardSlot(SlotType.World))">Add Section</MudButton>
                            </MudMenu>
                        </MudToolBar>
                        @if (AddWorldCardButton)
                        {
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Rounded.Add" OnClick="@( () => ShowCardSelectPopover())" Class="d-flex align-center justify-center">Add Card</MudButton>
                        }
                        <MudDropZone T="CardGameItem" Identifier="World" Class="d-flex mud-height-full align-center justify-center" />
                    </MudPaper>
                }
                <MudPopover Open="@CardSelectPopover" AnchorOrigin="@AnchorOrigin" TransformOrigin="@TransformOrigin" Class="px-4 pt-4">
                    <div class="d-flex flex-column">
                        <MudText>Content of the popover can be anything.</MudText>
                        <MudButton OnClick="@CloseCardSelectPopover" Class="ml-auto mr-n3 mb-1" Color="Color.Error">Close</MudButton>
                    </div>
                </MudPopover>
            </MudItem>

            <MudItem xs="6" Class="d-flex justify-center">
                @foreach (var item in _mindSections)
                {
                    <MudPaper Elevation="0" Width="160px" MinHeight="260px" Class="pa-4 ma-4 d-flex flex-column mud-background-gray rounded-lg" Style="color:#FFE5D9">
                        <MudToolBar DisableGutters="true">
                            <MudText Typo="Typo.subtitle1"><b>Mind</b></MudText>
                            <MudSpacer />
                            <MudMenu Icon="@Icons.Material.Rounded.MoreHoriz" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" ListClass="pa-2 d-flex flex-column" PopoverClass="mud-elevation-25">
                                <MudButton Size="Size.Small" Color="Color.Error" StartIcon="@Icons.Material.Outlined.Delete" OnClick="@( () => DeleteMindSection(item))">Delete Section</MudButton>
                                <MudButton Size="Size.Small" Color="Color.Default" StartIcon="@Icons.Material.Rounded.Add" OnClick="@( () => AddMindSection())">Add Section</MudButton>
                            </MudMenu>
                        </MudToolBar>
                        <MudDropZone T="CardGameItem" Identifier="@item.Name" Class="d-flex mud-height-full align-center justify-center" />
                    </MudPaper>
                }
            </MudItem>

            <MudItem xs="6" Class="d-flex justify-center">
                @foreach (var item in _heartSections)
                {
                    <MudPaper Elevation="0" Width="160px" MinHeight="260px" Class="pa-4 ma-4 d-flex flex-column rounded-lg mud-background-gray" Style="color:#FFCAD4">
                        <MudToolBar DisableGutters="true">
                            <MudText Typo="Typo.subtitle1"><b>Heart</b></MudText>
                            <MudSpacer />
                            <MudMenu Icon="@Icons.Material.Rounded.MoreHoriz" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" ListClass="pa-2 d-flex flex-column" PopoverClass="mud-elevation-25">
                                <MudButton Size="Size.Small" Color="Color.Error" StartIcon="@Icons.Material.Outlined.Delete" OnClick="@( () => DeleteHeartSection(item))">Delete Section</MudButton>
                                <MudButton Size="Size.Small" Color="Color.Default" StartIcon="@Icons.Material.Rounded.Add" OnClick="@( () => AddHeartSection())">Add Section</MudButton>
                            </MudMenu>
                        </MudToolBar>
                        <MudDropZone T="CardGameItem" Identifier="@item.Name" Class="d-flex mud-height-full align-center justify-center" />
                    </MudPaper>
                }
            </MudItem>

            <MudItem xs="12">
                <MudContainer Class="d-block align-center justify-center align-content-center mud-width-full pa-2">
                    <MudDropZone T="CardGameItem" Identifier="Hand" CanDrop="@((item) => true)" Class="rounded-lg mud-alert-text-normal pa-4 mt-6 mx-4 flex-grow-1 d-flex flex-wrap" />
                </MudContainer>
            </MudItem>
        </MudGrid>


    </ChildContent>
    <ItemRenderer>
        <MudPaper Elevation="25" Class="d-flex flex-grow-1 align-center justify-center rounded-lg pa-0 ma-2" Outlined="true" Width="132px" Height="228px">
            <MudContainer>
                <MudText>@context.Name</MudText>
            </MudContainer>
        </MudPaper>
    </ItemRenderer>
</MudDropContainer>



<MudButton OnClick="@ButtonSwap">ChangeButton</MudButton>
<MudText>Button is:  @AddWorldCardButton.ToString()</MudText>

@code {

    private MudDropContainer<CardGameItem> _dropContainer;

    private List<CardGameItem> _items = new();


    /* popover */
    public bool AddWorldCardButton { get; set; }
    public bool CardSelectPopover { get; set; }
    public Origin AnchorOrigin { get; set; } = Origin.CenterCenter;
    public Origin TransformOrigin { get; set; } = Origin.CenterCenter;

    /* handling board events */
    protected override async Task OnInitializedAsync()
    {
        await CardService.GetCards();
        PlaceCards();
        AddWorldCardButton = true;
    }

    private void ShowCardSelectPopover()
    {
        CardSelectPopover = true;
    }

    private void CloseCardSelectPopover()
    {
        CardSelectPopover = false;
    }

    private void ButtonSwap()
    {
        AddWorldCardButton = !AddWorldCardButton;
    }

    private void ItemUpdated(MudItemDropInfo<CardGameItem> info)
    {
        info.Item.Status = info.DropzoneIdentifier;
    }

    private void PlaceCards()
    {
        foreach (var card in CardService.Cards)
        {
            _items.Add(new CardGameItem(card.Title, card.Type, "Hand"));
        }
    }

    /* Setup for board  */
    public class CardGameItem
    {
        public string Name { get; set; }
        public string Status { get; set; }
        public CardType Type { get; set; }


        public CardGameItem(string name, CardType type, string status)
        {
            Name = name;
            Type = type;
            Status = status;
        }
    }

    private List<CardSlot> _cardSlots = new()
    {
        new CardSlot(SlotType.World),
        new CardSlot(SlotType.World),
        new CardSlot(SlotType.Mind),
        new CardSlot(SlotType.Heart)
    };

    public class CardSlot
    {
        public bool IsEmpty { get; set; }
        public SlotType SlotType { get; set; }
        public Guid Guid { get; set; }

        public CardSlot(SlotType slotType)
        {
            SlotType = slotType;
            Guid = Guid.NewGuid();
        }
    }

    private void DeleteCardSlot(CardSlot cardSlot)
    {
        var slotCount = (_cardSlots.Where(c => c.SlotType == cardSlot.SlotType).Count());

        if (slotCount <= 1)
        {
            //TODO: display popup warning user at least one slot is required
            return;
        }
        else
        {
            _cardSlots.Remove(cardSlot);
        }
    }

    private void AddCardSlot(SlotType slotType)
    {
        var slotCount = (_cardSlots.Where(c => c.SlotType == slotType).Count());

        if (slotCount >= 3)
        {
            //TODO: display popup warning user the max of this slot type has been reached
            return;
        }
        else
        {
            _cardSlots.Add(new CardSlot(slotType));
        }
    }



    private void AddWorldSection()
    {
        var sectionCount = _worldSections.Count;

        if (sectionCount >= 5)
        {
            return;
        }
        else
        {
            sectionCount += 1;
            var newSection = new WorldSection($"World{sectionCount}");
            _worldSections.Add(newSection);
        }
    }





    private List<WorldSection> _worldSections = new()
        {
            new WorldSection("World"),
        };

    public class WorldSection
    {
        public string Name { get; init; }
        public bool IsEmpty { get; set; }

        public WorldSection(string name)
        {
            Name = name;
            IsEmpty = true;
        }
    }

    private void DeleteWorldSection(WorldSection section)
    {
        if (_worldSections.Count <= 1)
        {
            return;
        }
        else
        {
            _worldSections.Remove(section);
        }
    }


    private List<MindSection> _mindSections = new()
        {
            new MindSection("Mind"),
        };

    public class MindSection
    {
        public string Name { get; init; }

        public MindSection(string name)
        {
            Name = name;
        }
    }

    private void DeleteMindSection(MindSection section)
    {
        if (_mindSections.Count <= 1)
        {
            return;
        }
        else
        {
            _mindSections.Remove(section);
        }
    }

    private void AddMindSection()
    {
        var sectionCount = _mindSections.Count;

        if (sectionCount >= 5)
        {
            return;
        }
        else
        {
            sectionCount += 1;
            var newSection = new MindSection($"Mind{sectionCount}");
            _mindSections.Add(newSection);
        }
    }

    private List<HeartSection> _heartSections = new()
        {
            new HeartSection("Heart"),
        };

    public class HeartSection
    {
        public string Name { get; init; }

        public HeartSection(string name)
        {
            Name = name;
        }
    }

    private void DeleteHeartSection(HeartSection section)
    {
        if (_heartSections.Count <= 1)
        {
            return;
        }
        else
        {
            _heartSections.Remove(section);
        }
    }

    private void AddHeartSection()
    {
        var sectionCount = _heartSections.Count;

        if (sectionCount >= 5)
        {
            return;
        }
        else
        {
            sectionCount += 1;
            var newSection = new HeartSection($"Heart{sectionCount}");
            _heartSections.Add(newSection);
        }
    }
}